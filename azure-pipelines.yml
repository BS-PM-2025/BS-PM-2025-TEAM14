trigger:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: "ubuntu-latest"

variables:
  pythonVersion: "3.11"
  nodeVersion: "20.x"
  CI: "true"
  DISABLE_ESLINT_PLUGIN: "true" # Temporarily disable ESLint plugin
  SKIP_PREFLIGHT_CHECK: "true" # Skip preflight checks

stages:
  - stage: Build
    displayName: "Build • Test • Report"
    jobs:
      - job: BuildAndTest
        displayName: "Build And Test Application"
        steps:
#          # Frontend Build
#          - task: NodeTool@0
#            displayName: "Install Node.js"
#            inputs:
#              versionSpec: "$(nodeVersion)"
#
#          - script: |
#              cd frontend
#              npm install --legacy-peer-deps
#              npm install react-scripts --save-dev
#              npm run build
#            displayName: "Build Frontend"
#            timeoutInMinutes: 10
#            env:
#              CI: "false" # Prevent treating warnings as errors
#              NODE_ENV: "test"

          # Backend Build and Test
          - task: UsePythonVersion@0
            displayName: "Use Python $(pythonVersion)"
            inputs:
              versionSpec: "$(pythonVersion)"
              addToPath: true

          - script: |
              python -m pip install --upgrade pip
              cd backend
              pip install -r requirements.txt
              cd ..
              pytest
            displayName: "Run Backend Unit Tests"

          - bash: |
              total=$(python -c "import json, pathlib, sys; p=pathlib.Path('backend/pytest-report.json'); 
              print(json.loads(p.read_text())['summary']['collected'] if p.exists() else 0)")
              echo \"##vso[task.setvariable variable=UNIT_TEST_COUNT]$total\"
              echo \"TOTAL UNIT TESTS: $total\"
            displayName: "Aggregate Test Count"

          - publish: backend/pytest-report.json
            artifact: test-metrics-json
            displayName: "Publish pytest JSON Report"

          - publish: backend/pytest-report.xml
            artifact: test-metrics-xml
            displayName: "Publish pytest XML report"

          - publish: backend/coverage.xml
            artifact: coverage
            displayName: "Publish Code Coverage XML"

          - task: PublishTestResults@2
            displayName: "Publish Tests to Dashboard"
            inputs:
              testResultsFormat: JUnit
              testResultsFiles: backend/pytest-report.xml
              mergeTestResults: true

          - task: PublishCodeCoverageResults@2
            displayName: "Publish Coverage to Dashboard"
            inputs:
              codeCoverageTool: Cobertura
              summaryFileLocation: "backend/coverage.xml"
              reportDirectory: "backend/coverage_html"